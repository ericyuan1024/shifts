generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  EMPLOYEE
  ADMIN
}

enum PreferenceChoice {
  WANT
  CAN
  CANT
}

enum ScheduleStatus {
  DRAFT
  FINALIZED
}

enum AssignmentSource {
  AUTO
  MANUAL
}

model User {
  id           String       @id @default(cuid())
  name         String
  role         UserRole     @default(EMPLOYEE)
  passcodeHash String       @unique
  weight       Int          @default(1)
  maxHoursWeek Int          @default(24)
  roleTypeId   String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  preferences  Preference[]
  assignments  Assignment[]
  sessions     Session[]
  availabilityTemplates AvailabilityTemplate[]

  roleType     RoleType?    @relation(fields: [roleTypeId], references: [id], onDelete: SetNull)
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RoleType {
  id        String       @id @default(cuid())
  name      String       @unique
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  templates ShiftTemplate[]
  slots     ShiftSlot[]
  users     User[]
  availabilityTemplates AvailabilityTemplate[]
}

model ShiftTemplate {
  id         String    @id @default(cuid())
  roleTypeId String
  dayOfWeek  Int
  startTime  String
  endTime    String
  hours      Float
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  roleType RoleType @relation(fields: [roleTypeId], references: [id], onDelete: Cascade)

  @@index([dayOfWeek])
}

model Week {
  id        String   @id @default(cuid())
  startDate DateTime @unique
  createdAt DateTime @default(now())

  slots     ShiftSlot[]
  schedule  Schedule?
}

model ShiftSlot {
  id         String    @id @default(cuid())
  weekId     String
  roleTypeId String
  date       DateTime
  startAt    DateTime
  endAt      DateTime
  hours      Float
  createdAt  DateTime  @default(now())

  week     Week     @relation(fields: [weekId], references: [id], onDelete: Cascade)
  roleType RoleType @relation(fields: [roleTypeId], references: [id], onDelete: Cascade)

  preferences Preference[]
  assignment  Assignment?

  @@index([weekId])
  @@index([roleTypeId])
  @@unique([weekId, roleTypeId, startAt, endAt])
}

model Preference {
  id         String            @id @default(cuid())
  userId     String
  shiftSlotId String
  choice     PreferenceChoice
  updatedAt  DateTime          @updatedAt
  createdAt  DateTime          @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  shiftSlot ShiftSlot @relation(fields: [shiftSlotId], references: [id], onDelete: Cascade)

  @@unique([userId, shiftSlotId])
  @@index([shiftSlotId])
}

model AvailabilityTemplate {
  id         String            @id @default(cuid())
  userId     String
  roleTypeId String
  dayOfWeek  Int
  startTime  String
  endTime    String
  hours      Float
  choice     PreferenceChoice
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleType RoleType @relation(fields: [roleTypeId], references: [id], onDelete: Cascade)

  @@unique([userId, roleTypeId, dayOfWeek, startTime, endTime])
  @@index([roleTypeId])
}

model Schedule {
  id          String         @id @default(cuid())
  weekId      String         @unique
  status      ScheduleStatus @default(DRAFT)
  version     Int            @default(1)
  generatedAt DateTime?
  finalizedAt DateTime?

  week        Week       @relation(fields: [weekId], references: [id], onDelete: Cascade)
  assignments Assignment[]
}

model Assignment {
  id         String           @id @default(cuid())
  scheduleId String
  shiftSlotId String          @unique
  userId     String
  source     AssignmentSource
  createdAt  DateTime         @default(now())

  schedule Schedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  shiftSlot ShiftSlot @relation(fields: [shiftSlotId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([userId])
}
